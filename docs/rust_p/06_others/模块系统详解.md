# Rust 模块系统：单文件 vs 文件夹模块

## 概述

Rust 的模块系统有两种组织方式：
1. **单文件模块**：一个 `.rs` 文件就是一个模块
2. **文件夹模块**：一个文件夹代表一个模块，使用 `mod.rs` 或同名文件

## 一、单文件模块

### 基本结构

```
my_project/
├── Cargo.toml
└── src/
    ├── main.rs
    ├── utils.rs          ← 单文件模块
    └── database.rs       ← 单文件模块
```

### 使用方式

```rust
// src/main.rs
mod utils;      // 声明模块（告诉编译器去找 utils.rs）
mod database;   // 声明模块

fn main() {
    utils::helper_function();
    database::connect();
}
```

```rust
// src/utils.rs
pub fn helper_function() {
    println!("这是工具函数");
}

pub fn another_helper() {
    println!("另一个工具函数");
}
```

```rust
// src/database.rs
pub fn connect() {
    println!("连接数据库");
}

pub fn query(sql: &str) {
    println!("执行查询: {}", sql);
}
```

**特点**：
- ✅ 简单直接
- ✅ 适合小模块
- ✅ 一个文件对应一个模块
- ❌ 不适合复杂的子模块结构

---

## 二、文件夹模块（使用 mod.rs）

### 基本结构

```
my_project/
├── Cargo.toml
└── src/
    ├── main.rs
    └── network/          ← 文件夹模块
        ├── mod.rs        ← 模块入口（类似 Python 的 __init__.py）
        ├── tcp.rs
        ├── udp.rs
        └── http.rs
```

### 文件内容

```rust
// src/main.rs
mod network;  // 声明模块（编译器会找 network/mod.rs）

fn main() {
    network::tcp::connect();
    network::http::get();
}
```

```rust
// src/network/mod.rs - 模块入口
// 声明子模块
pub mod tcp;
pub mod udp;
pub mod http;

// 可以在这里定义公共功能
pub fn init() {
    println!("网络模块初始化");
}

// 可以重新导出（re-export）
pub use tcp::TcpConnection;
pub use http::{Request, Response};
```

```rust
// src/network/tcp.rs
pub struct TcpConnection {
    address: String,
}

impl TcpConnection {
    pub fn new(addr: &str) -> Self {
        TcpConnection {
            address: addr.to_string(),
        }
    }
}

pub fn connect() {
    println!("TCP 连接");
}
```

```rust
// src/network/http.rs
pub struct Request {
    pub url: String,
}

pub struct Response {
    pub status: u16,
}

pub fn get() {
    println!("HTTP GET 请求");
}
```

**特点**：
- ✅ 适合复杂模块
- ✅ 清晰的层次结构
- ✅ 可以有多层嵌套
- ✅ `mod.rs` 作为模块入口

---

## 三、现代方式（Rust 2018+）：同名文件

Rust 2018 引入了新的方式，不再必须使用 `mod.rs`。

### 基本结构

```
my_project/
├── Cargo.toml
└── src/
    ├── main.rs
    ├── network.rs        ← 模块文件（代替 network/mod.rs）
    └── network/          ← 子模块文件夹
        ├── tcp.rs
        ├── udp.rs
        └── http.rs
```

### 文件内容

```rust
// src/main.rs
mod network;  // 编译器会找 network.rs

fn main() {
    network::tcp::connect();
}
```

```rust
// src/network.rs - 模块定义（代替 mod.rs）
pub mod tcp;
pub mod udp;
pub mod http;

pub fn init() {
    println!("网络模块初始化");
}
```

```rust
// src/network/tcp.rs
pub fn connect() {
    println!("TCP 连接");
}
```

**对比**：

| 方式 | Rust 2015 | Rust 2018+ |
|------|-----------|------------|
| 模块入口 | `network/mod.rs` | `network.rs` |
| 子模块 | `network/*.rs` | `network/*.rs` |
| 推荐度 | 旧方式 | ✅ 推荐 |

---

## 四、完整示例对比

### 方式 1：使用 mod.rs（传统）

```
src/
├── main.rs
└── api/
    ├── mod.rs        ← 模块入口
    ├── users.rs
    ├── posts.rs
    └── auth/
        ├── mod.rs    ← 子模块入口
        ├── login.rs
        └── logout.rs
```

```rust
// src/api/mod.rs
pub mod users;
pub mod posts;
pub mod auth;

pub fn init_api() {
    println!("API 初始化");
}
```

```rust
// src/api/auth/mod.rs
pub mod login;
pub mod logout;

pub fn init_auth() {
    println!("认证模块初始化");
}
```

### 方式 2：使用同名文件（现代）

```
src/
├── main.rs
├── api.rs            ← 代替 api/mod.rs
├── api/
│   ├── users.rs
│   ├── posts.rs
│   ├── auth.rs       ← 代替 api/auth/mod.rs
│   └── auth/
│       ├── login.rs
│       └── logout.rs
```

```rust
// src/api.rs（代替 api/mod.rs）
pub mod users;
pub mod posts;
pub mod auth;

pub fn init_api() {
    println!("API 初始化");
}
```

```rust
// src/api/auth.rs（代替 api/auth/mod.rs）
pub mod login;
pub mod logout;

pub fn init_auth() {
    println!("认证模块初始化");
}
```

**推荐使用方式 2**，因为：
- ✅ 更清晰：文件名就是模块名
- ✅ 避免多个 `mod.rs` 混淆
- ✅ 编辑器中更容易识别

---

## 五、Rust vs Python 对比

### Python 的模块系统

```
my_project/
├── main.py
└── network/
    ├── __init__.py    ← 包初始化文件
    ├── tcp.py
    ├── http.py
    └── auth/
        ├── __init__.py
        ├── login.py
        └── logout.py
```

```python
# main.py
from network import tcp
from network.auth import login

tcp.connect()
login.authenticate()
```

```python
# network/__init__.py
# 初始化代码
print("网络模块加载")

# 可以重新导出
from .tcp import connect
from .http import get

__all__ = ['connect', 'get']
```

```python
# network/tcp.py
def connect():
    print("TCP 连接")
```

### Rust 的模块系统（对应设计）

```
my_project/
├── main.rs
└── network/
    ├── mod.rs         ← 对应 __init__.py
    ├── tcp.rs
    ├── http.rs
    └── auth/
        ├── mod.rs     ← 对应 __init__.py
        ├── login.rs
        └── logout.rs
```

```rust
// main.rs
mod network;

use network::tcp;
use network::auth::login;

fn main() {
    tcp::connect();
    login::authenticate();
}
```

```rust
// network/mod.rs - 对应 __init__.py
pub mod tcp;
pub mod http;
pub mod auth;

// 初始化代码
pub fn init() {
    println!("网络模块加载");
}

// 重新导出（对应 __all__）
pub use tcp::connect;
pub use http::get;
```

```rust
// network/tcp.rs
pub fn connect() {
    println!("TCP 连接");
}
```

### 详细对比表

| 特性 | Python | Rust (mod.rs) | Rust (现代) |
|------|--------|---------------|-------------|
| **包/模块入口** | `__init__.py` | `mod.rs` | `模块名.rs` |
| **必需性** | 可选（Python 3.3+） | 必需 | 必需 |
| **导入语法** | `import` / `from...import` | `mod` + `use` | `mod` + `use` |
| **重新导出** | `__all__` | `pub use` | `pub use` |
| **可见性** | 默认公开 | 默认私有 | 默认私有 |
| **编译时检查** | ❌ | ✅ | ✅ |
| **相对导入** | `from .module` | `use super::` | `use super::` |

---

## 六、复杂项目实例

### Rust 项目结构

```
my_web_app/
├── Cargo.toml
└── src/
    ├── main.rs
    ├── lib.rs               ← 库入口
    ├── config.rs            ← 单文件模块
    ├── models.rs            ← 模块文件
    ├── models/              ← 子模块文件夹
    │   ├── user.rs
    │   ├── post.rs
    │   └── comment.rs
    ├── api.rs
    ├── api/
    │   ├── users.rs
    │   ├── posts.rs
    │   └── auth.rs
    └── database.rs
    └── database/
        ├── connection.rs
        └── migrations.rs
```

### 各文件内容

```rust
// src/lib.rs - 库的根模块
pub mod config;
pub mod models;
pub mod api;
pub mod database;

// 重新导出常用项
pub use models::{User, Post};
pub use api::users::create_user;
pub use database::Connection;
```

```rust
// src/main.rs - 可执行文件
use my_web_app::{User, create_user, Connection};

fn main() {
    let user = User::new("Alice");
    let conn = Connection::connect();
}
```

```rust
// src/models.rs
pub mod user;
pub mod post;
pub mod comment;

// 重新导出
pub use user::User;
pub use post::Post;
pub use comment::Comment;
```

```rust
// src/models/user.rs
#[derive(Debug, Clone)]
pub struct User {
    pub id: u64,
    pub name: String,
}

impl User {
    pub fn new(name: &str) -> Self {
        User {
            id: 0,
            name: name.to_string(),
        }
    }
}
```

```rust
// src/api.rs
pub mod users;
pub mod posts;
pub mod auth;

pub fn init() {
    println!("API 初始化");
}
```

```rust
// src/api/users.rs
use crate::models::User;

pub fn create_user(name: &str) -> User {
    User::new(name)
}

pub fn get_user(id: u64) -> Option<User> {
    // ...
    None
}
```

---

## 七、路径和导入

### 绝对路径 vs 相对路径

```rust
// src/api/users.rs

// ❌ 不推荐：绝对路径（从 crate 根开始）
use crate::models::user::User;
use crate::database::connection::Connection;

// ✅ 推荐：使用 crate:: 从根开始
use crate::models::User;
use crate::database::Connection;

// ✅ 相对路径：从当前模块开始
use super::auth::authenticate;  // 上一级的 auth 模块
use super::super::models::Post; // 上两级的 models

// 当前模块内
use self::helpers::format_response;
```

### Python 对比

```python
# network/auth/login.py

# 绝对导入
from network.tcp import connect
from network.auth.helpers import validate

# 相对导入
from ..tcp import connect        # 上一级
from .helpers import validate    # 当前级
from ...utils import log         # 上两级
```

### Rust 路径关键字

```rust
// crate:: - 从当前 crate 的根开始
use crate::models::User;

// super:: - 父模块
use super::auth::Token;

// self:: - 当前模块
use self::helpers::format;
```

---

## 八、可见性控制

### Rust 的精细控制

```rust
// src/models/user.rs

// 公开给所有人
pub struct User {
    pub id: u64,              // 公开字段
    pub name: String,         // 公开字段
    email: String,            // 私有字段（默认）
}

// 仅在当前 crate 内公开
pub(crate) fn internal_helper() {
    // 只能在当前 crate 内使用
}

// 仅在父模块中公开
pub(super) fn parent_only() {
    // 只能在父模块使用
}

// 仅在指定路径中公开
pub(in crate::models) fn models_only() {
    // 只能在 models 模块内使用
}

// 完全私有
fn private_function() {
    // 只能在当前文件内使用
}
```

### Python 的约定

```python
# network/tcp.py

# "公开" - 无前缀
def connect():
    pass

# "内部" - 单下划线（约定，不强制）
def _internal_helper():
    pass

# "私有" - 双下划线（名称改写）
def __private():
    pass

# __all__ 控制 from module import * 的内容
__all__ = ['connect']
```

**关键区别**：
- Rust：编译时强制检查
- Python：运行时约定（不强制）

---

## 九、最佳实践

### ✅ 推荐做法

```rust
// 1. 使用现代模块系统（同名文件而非 mod.rs）
src/
├── api.rs          ← 而不是 api/mod.rs
└── api/
    └── users.rs

// 2. 在模块文件中重新导出常用项
// src/models.rs
pub mod user;
pub mod post;

pub use user::User;
pub use post::Post;

// 3. 使用 prelude 模式简化导入
// src/prelude.rs
pub use crate::models::{User, Post};
pub use crate::errors::AppError;
pub use crate::Result;

// 使用者只需：
use my_app::prelude::*;

// 4. 合理组织大型项目
src/
├── lib.rs           ← 库入口，重新导出 API
├── api/             ← 按功能分组
├── models/          ← 按数据模型分组
├── services/        ← 按服务分组
└── utils/           ← 工具函数
```

### ❌ 避免做法

```rust
// 1. 不要过度嵌套
src/
└── api/
    └── v1/
        └── public/
            └── users/
                └── handlers/  ← 太深了！

// 2. 不要在 mod.rs 中写太多逻辑
// src/api/mod.rs
pub mod users;
// ❌ 不要在这里定义大量结构体和函数
// 应该在单独的文件中

// 3. 不要混用两种风格
src/
├── old_module/
│   └── mod.rs       ← 旧风格
├── new_module.rs    ← 新风格
└── new_module/      ← 混乱！
```

---

## 十、总结对比

### Rust 模块系统的优势

✅ **编译时检查**：模块路径错误在编译时发现  
✅ **明确的可见性**：`pub`、`pub(crate)` 等精确控制  
✅ **零成本抽象**：模块在编译后不存在  
✅ **强制性**：必须显式声明 `mod`

### Python 模块系统的优势

✅ **动态灵活**：可以在运行时修改模块  
✅ **简单易懂**：文件即模块  
✅ **自动发现**：不需要显式声明  
✅ **可选入口**：`__init__.py` 可选（Python 3.3+）

### 相似之处

| 功能 | Rust | Python |
|------|------|--------|
| 模块入口 | `mod.rs` / `模块名.rs` | `__init__.py` |
| 重新导出 | `pub use` | `__all__` |
| 子模块 | `pub mod` | 子文件/子文件夹 |
| 相对导入 | `super::`, `self::` | `..`, `.` |

---

## 实战练习

创建一个图书管理系统：

```
library_system/
├── Cargo.toml
└── src/
    ├── main.rs
    ├── lib.rs
    ├── models.rs
    ├── models/
    │   ├── book.rs
    │   ├── author.rs
    │   └── category.rs
    ├── services.rs
    ├── services/
    │   ├── library.rs
    │   └── search.rs
    └── utils.rs
```

试着自己实现这个结构，并理解模块之间的关系！

---

**总结**：Rust 的模块系统比 Python 更严格但也更安全。掌握 `mod.rs` 和现代模块组织方式，能让你的项目结构更清晰！🦀📚

