<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>OnceLock å’Œ OnceCell è¯¦è§£ | X-Lang</title><meta name="description" content="X-Lang: Code Smarter, in Every Language.">
    <link rel="preload" href="/x-lang/assets/style-B3-VMakp.css" as="style"><link rel="stylesheet" href="/x-lang/assets/style-B3-VMakp.css">
    <link rel="modulepreload" href="/x-lang/assets/app-WzcM213c.js"><link rel="modulepreload" href="/x-lang/assets/OnceLockå’ŒOnceCell.html-xnx4uSV4.js">
    <link rel="prefetch" href="/x-lang/assets/index.html-B2siAs7W.js" as="script"><link rel="prefetch" href="/x-lang/assets/index.html-Ct6QxUzD.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_environment.html-D1fL_jqt.js" as="script"><link rel="prefetch" href="/x-lang/assets/02_variables_types.html-BmiEJ1Bj.js" as="script"><link rel="prefetch" href="/x-lang/assets/03_control_flow.html-A8hUj0Pt.js" as="script"><link rel="prefetch" href="/x-lang/assets/04_functions.html-f8I0OP4v.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_ownership.html-CRoCEPqb.js" as="script"><link rel="prefetch" href="/x-lang/assets/02_borrowing.html-B7xp1ev4.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_structs_enums.html-LdID-277.js" as="script"><link rel="prefetch" href="/x-lang/assets/02_collections.html-Ds1byo85.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_error_handling.html-BEqF59Lp.js" as="script"><link rel="prefetch" href="/x-lang/assets/02_modules_packages.html-C1p_7CJQ.js" as="script"><link rel="prefetch" href="/x-lang/assets/03_std_library_guide.html-ChLXr3fo.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_calculator.html-CGJdt9pH.js" as="script"><link rel="prefetch" href="/x-lang/assets/02_file_processor.html-DiMiS9mp.js" as="script"><link rel="prefetch" href="/x-lang/assets/03_web_server.html-8mUg2UM6.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_1è¿‡ç¨‹å®.html-tTmy0kCp.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_2æ´¾ç”Ÿå®.html-D1_ZdORP.js" as="script"><link rel="prefetch" href="/x-lang/assets/02_å£°æ˜å®.html-BBmhDVIo.js" as="script"><link rel="prefetch" href="/x-lang/assets/Attributeè¯­æ³•.html-jaTtHbhv.js" as="script"><link rel="prefetch" href="/x-lang/assets/mod_rså’Œlib_rsçš„åŒºåˆ«.html-CBHSW1uF.js" as="script"><link rel="prefetch" href="/x-lang/assets/å¯è§æ€§ä¿®é¥°ç¬¦å¯¹æ¯”.html-BRXY5TwU.js" as="script"><link rel="prefetch" href="/x-lang/assets/æ¨¡å—ç³»ç»Ÿè¯¦è§£.html-DY6bo69Q.js" as="script"><link rel="prefetch" href="/x-lang/assets/uniffi__export.html-BFkgJZVD.js" as="script"><link rel="prefetch" href="/x-lang/assets/01_tokio_intro.html-DZi8tRvm.js" as="script"><link rel="prefetch" href="/x-lang/assets/02_async_basics.html-WBHDavJh.js" as="script"><link rel="prefetch" href="/x-lang/assets/03_tokio_runtime.html-BYsm7zlR.js" as="script"><link rel="prefetch" href="/x-lang/assets/04_tokio_vs_others.html-bhI0LqRA.js" as="script"><link rel="prefetch" href="/x-lang/assets/05_projects.html-DL-x2NmQ.js" as="script"><link rel="prefetch" href="/x-lang/assets/index.html-DYIGJVtN.js" as="script"><link rel="prefetch" href="/x-lang/assets/index.html-DfalU3op.js" as="script"><link rel="prefetch" href="/x-lang/assets/basic_exercises.html-ChnlXsbq.js" as="script"><link rel="prefetch" href="/x-lang/assets/404.html-Wz41JpZm.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/x-lang/"><img class="vp-site-logo" src="/x-lang/images/logo.png" alt="X-Lang"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">X-Lang</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/x-lang/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/x-lang/rust_p/" aria-label="Rust è¯­è¨€å…¥é—¨æ•™ç¨‹"><!--[--><!--[--><!--]--><!--]-->Rust è¯­è¨€å…¥é—¨æ•™ç¨‹<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/x-lang/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/x-lang/rust_p/" aria-label="Rust è¯­è¨€å…¥é—¨æ•™ç¨‹"><!--[--><!--[--><!--]--><!--]-->Rust è¯­è¨€å…¥é—¨æ•™ç¨‹<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">OnceLock å’Œ OnceCell è¯¦è§£ <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="oncelock-å’Œ-oncecell-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#oncelock-å’Œ-oncecell-è¯¦è§£"><span>OnceLock å’Œ OnceCell è¯¦è§£</span></a></h1><h2 id="ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ"><span>ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ</span></a></h2><p><strong>å»¶è¿Ÿåˆå§‹åŒ–</strong>å’Œ<strong>å•æ¬¡èµ‹å€¼</strong>ï¼šåˆ›å»ºæ—¶ä¸ºç©ºï¼Œåªèƒ½èµ‹å€¼ä¸€æ¬¡ï¼Œé€‚åˆå…¨å±€å•ä¾‹å’Œæ‡’åŠ è½½ã€‚</p><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">let</span> cell <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">cell<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// âœ… ç¬¬ä¸€æ¬¡æˆåŠŸ</span></span>
<span class="line">cell<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// âŒ ç¬¬äºŒæ¬¡å¤±è´¥</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="äºŒã€ä¸‰ç§ç±»å‹å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#äºŒã€ä¸‰ç§ç±»å‹å¯¹æ¯”"><span>äºŒã€ä¸‰ç§ç±»å‹å¯¹æ¯”</span></a></h2><h3 id="æ ¸å¿ƒåŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒåŒºåˆ«"><span>æ ¸å¿ƒåŒºåˆ«</span></a></h3><table><thead><tr><th>ç‰¹æ€§</th><th><code>std::cell::OnceCell</code></th><th><code>std::sync::OnceLock</code></th><th><code>tokio::sync::OnceCell</code></th></tr></thead><tbody><tr><td><strong>çº¿ç¨‹å®‰å…¨</strong></td><td>âŒ</td><td>âœ…</td><td>âœ…</td></tr><tr><td><strong>å¼‚æ­¥</strong></td><td>âŒ</td><td>âŒ</td><td>âœ…</td></tr><tr><td><strong>ä½ç½®</strong></td><td><code>std::cell</code></td><td><code>std::sync</code></td><td><code>tokio::sync</code></td></tr><tr><td><strong>ç­‰å¾…æœºåˆ¶</strong></td><td>å•çº¿ç¨‹</td><td>é˜»å¡çº¿ç¨‹</td><td>yield ä»»åŠ¡</td></tr><tr><td><strong>åœºæ™¯</strong></td><td>å•çº¿ç¨‹åŒæ­¥</td><td>å¤šçº¿ç¨‹åŒæ­¥</td><td><strong>å¼‚æ­¥è¿è¡Œæ—¶</strong></td></tr></tbody></table><h3 id="å¿«é€Ÿé€‰æ‹©" tabindex="-1"><a class="header-anchor" href="#å¿«é€Ÿé€‰æ‹©"><span>å¿«é€Ÿé€‰æ‹©</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">éœ€è¦å»¶è¿Ÿåˆå§‹åŒ–ï¼Ÿ</span>
<span class="line">â”‚</span>
<span class="line">â”œâ”€ åœ¨ Tokio å¼‚æ­¥ç¯å¢ƒï¼Ÿ</span>
<span class="line">â”‚  â””â”€â†’ tokio::sync::OnceCell âœ…</span>
<span class="line">â”‚</span>
<span class="line">â”œâ”€ å•çº¿ç¨‹åŒæ­¥ï¼Ÿ</span>
<span class="line">â”‚  â””â”€â†’ std::cell::OnceCell</span>
<span class="line">â”‚</span>
<span class="line">â””â”€ å¤šçº¿ç¨‹åŒæ­¥ï¼Ÿ</span>
<span class="line">   â””â”€â†’ std::sync::OnceLock</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="ä¸‰ã€åŸºç¡€ç”¨æ³•" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€åŸºç¡€ç”¨æ³•"><span>ä¸‰ã€åŸºç¡€ç”¨æ³•</span></a></h2><h3 id="_1-oncecell-å•çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#_1-oncecell-å•çº¿ç¨‹"><span>1. OnceCellï¼ˆå•çº¿ç¨‹ï¼‰</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">OnceCell</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> cell <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è®¾ç½®</span></span>
<span class="line">cell<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è·å–</span></span>
<span class="line"><span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>cell<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ‡’åŠ è½½</span></span>
<span class="line"><span class="token keyword">let</span> value <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;é¦–æ¬¡åˆå§‹åŒ–&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token number">42</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-oncelock-å¤šçº¿ç¨‹åŒæ­¥" tabindex="-1"><a class="header-anchor" href="#_2-oncelock-å¤šçº¿ç¨‹åŒæ­¥"><span>2. OnceLockï¼ˆå¤šçº¿ç¨‹åŒæ­¥ï¼‰</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceLock</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">CONFIG</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">get_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> <span class="token class-name">String</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;é…ç½®æ•°æ®&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-tokio-oncecell-å¼‚æ­¥" tabindex="-1"><a class="header-anchor" href="#_3-tokio-oncecell-å¼‚æ­¥"><span>3. Tokio OnceCellï¼ˆå¼‚æ­¥ï¼‰</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">tokio<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceCell</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">OnceCell</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">const_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> <span class="token class-name">String</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">DATA</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¼‚æ­¥åˆå§‹åŒ–</span></span>
<span class="line">        <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;å¼‚æ­¥æ•°æ®&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="å››ã€å…³é”®é—®é¢˜è§£ç­”" tabindex="-1"><a class="header-anchor" href="#å››ã€å…³é”®é—®é¢˜è§£ç­”"><span>å››ã€å…³é”®é—®é¢˜è§£ç­”</span></a></h2><h3 id="âš ï¸-é—®é¢˜1-çº¿ç¨‹å®‰å…¨-å¼‚æ­¥" tabindex="-1"><a class="header-anchor" href="#âš ï¸-é—®é¢˜1-çº¿ç¨‹å®‰å…¨-å¼‚æ­¥"><span>âš ï¸ é—®é¢˜1ï¼šçº¿ç¨‹å®‰å…¨ â‰  å¼‚æ­¥</span></a></h3><p><strong>é‡è¦</strong>ï¼š<code>OnceLock</code> æ˜¯<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ï¼Œä½†<strong>ä¸æ˜¯å¼‚æ­¥</strong>çš„ï¼</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">çº¿ç¨‹å®‰å…¨ï¼ˆThread-Safeï¼‰</span>
<span class="line">- å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å®‰å…¨è®¿é—®</span>
<span class="line">- âœ… OnceLock æ˜¯çº¿ç¨‹å®‰å…¨çš„</span>
<span class="line">- âœ… tokio::OnceCell ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„</span>
<span class="line"></span>
<span class="line">å¼‚æ­¥ï¼ˆAsyncï¼‰</span>
<span class="line">- ç­‰å¾…æ—¶ä¸é˜»å¡çº¿ç¨‹ï¼Œå¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡</span>
<span class="line">- âŒ OnceLock ä¸æ˜¯å¼‚æ­¥çš„ï¼ˆä¼šé˜»å¡ï¼‰</span>
<span class="line">- âœ… tokio::OnceCell æ˜¯å¼‚æ­¥çš„</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ”¥-é—®é¢˜2-ä¸ºä»€ä¹ˆ-tokio-è¦é‡æ–°å®ç°" tabindex="-1"><a class="header-anchor" href="#ğŸ”¥-é—®é¢˜2-ä¸ºä»€ä¹ˆ-tokio-è¦é‡æ–°å®ç°"><span>ğŸ”¥ é—®é¢˜2ï¼šä¸ºä»€ä¹ˆ Tokio è¦é‡æ–°å®ç°ï¼Ÿ</span></a></h3><p>å› ä¸º <strong><code>OnceLock</code> ä¼šé˜»å¡çº¿ç¨‹</strong>ï¼Œåœ¨å¼‚æ­¥ç¯å¢ƒä¸­ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼</p><h4 id="é˜»å¡ç¤ºä¾‹-oncelock" tabindex="-1"><a class="header-anchor" href="#é˜»å¡ç¤ºä¾‹-oncelock"><span>é˜»å¡ç¤ºä¾‹ï¼ˆOnceLockï¼‰</span></a></h4><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token attribute attr-name">#[tokio::main(flavor = <span class="token string">&quot;current_thread&quot;</span>)]</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»»åŠ¡1ï¼šå¿«é€Ÿä»»åŠ¡</span></span>
<span class="line">    <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;ä»»åŠ¡1: {}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»»åŠ¡2ï¼šä½¿ç”¨ OnceLock</span></span>
<span class="line">    <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token constant">DATA</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// âš ï¸ é˜»å¡æ•´ä¸ªçº¿ç¨‹ 2 ç§’ï¼</span></span>
<span class="line">            <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¾“å‡ºï¼š</span></span>
<span class="line"><span class="token comment">// ä»»åŠ¡1: 0</span></span>
<span class="line"><span class="token comment">// ï¼ˆ2ç§’é˜»å¡ï¼Œä»»åŠ¡1æ— æ³•æ‰§è¡Œï¼‰</span></span>
<span class="line"><span class="token comment">// ä»»åŠ¡1: 1</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¼‚æ­¥ç¤ºä¾‹-tokio-oncecell" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥ç¤ºä¾‹-tokio-oncecell"><span>å¼‚æ­¥ç¤ºä¾‹ï¼ˆTokio OnceCellï¼‰</span></a></h4><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token attribute attr-name">#[tokio::main(flavor = <span class="token string">&quot;current_thread&quot;</span>)]</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">OnceCell</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">const_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»»åŠ¡1ï¼šå¿«é€Ÿä»»åŠ¡</span></span>
<span class="line">    <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;ä»»åŠ¡1: {}&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»»åŠ¡2ï¼šä½¿ç”¨ Tokio OnceCell</span></span>
<span class="line">    <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token constant">DATA</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// âœ… å¼‚æ­¥ç­‰å¾…ï¼Œä¸é˜»å¡çº¿ç¨‹</span></span>
<span class="line">            <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¾“å‡ºï¼š</span></span>
<span class="line"><span class="token comment">// ä»»åŠ¡1: 0</span></span>
<span class="line"><span class="token comment">// ä»»åŠ¡1: 1  â† åˆå§‹åŒ–æœŸé—´ä»èƒ½æ‰§è¡Œï¼</span></span>
<span class="line"><span class="token comment">// ä»»åŠ¡1: 2</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸš—-ç±»æ¯”ç†è§£" tabindex="-1"><a class="header-anchor" href="#ğŸš—-ç±»æ¯”ç†è§£"><span>ğŸš— ç±»æ¯”ç†è§£</span></a></h3><p><strong>OnceLockï¼ˆé˜»å¡ï¼‰</strong>ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">çº¿ç¨‹ï¼š[ä»»åŠ¡Aç­‰å¾…ğŸš—ğŸ”´.............]</span>
<span class="line">      â†‘ æ•´æ¡è·¯è¢«å ç”¨ï¼Œå…¶ä»–ä»»åŠ¡æ— æ³•é€šè¡Œ âŒ</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Tokio OnceCellï¼ˆå¼‚æ­¥ï¼‰</strong>ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">çº¿ç¨‹ï¼š[ä»»åŠ¡BğŸš— ä»»åŠ¡CğŸš— ä»»åŠ¡DğŸš—]</span>
<span class="line">      â†‘ ä»»åŠ¡Aè®©å‡ºé“è·¯ï¼Œå…¶ä»–ä»»åŠ¡ç»§ç»­ âœ…</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ğŸ“Š-æ€§èƒ½å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-æ€§èƒ½å¯¹æ¯”"><span>ğŸ“Š æ€§èƒ½å¯¹æ¯”</span></a></h3><table><thead><tr><th>åœºæ™¯</th><th>OnceLock</th><th>Tokio OnceCell</th></tr></thead><tbody><tr><td>å•çº¿ç¨‹è¿è¡Œæ—¶</td><td>é˜»å¡æ‰€æœ‰ä»»åŠ¡</td><td>ä»…ç­‰å¾…åˆå§‹åŒ–çš„ä»»åŠ¡æš‚åœ</td></tr><tr><td>å¤šçº¿ç¨‹è¿è¡Œæ—¶</td><td>é˜»å¡ä¸€ä¸ªçº¿ç¨‹</td><td>ä¸é˜»å¡çº¿ç¨‹</td></tr><tr><td>100ä¸ªå¹¶å‘è¯·æ±‚</td><td>å¯èƒ½ä¾æ¬¡å¤„ç†</td><td>å¹¶å‘å¤„ç†</td></tr></tbody></table><hr><h2 id="äº”ã€å®æˆ˜åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#äº”ã€å®æˆ˜åœºæ™¯"><span>äº”ã€å®æˆ˜åœºæ™¯</span></a></h2><h3 id="åœºæ™¯1-å…¨å±€é…ç½®" tabindex="-1"><a class="header-anchor" href="#åœºæ™¯1-å…¨å±€é…ç½®"><span>åœºæ™¯1ï¼šå…¨å±€é…ç½®</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceLock</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token attribute attr-name">#[derive(Clone)]</span></span>
<span class="line"><span class="token keyword">struct</span> <span class="token type-definition class-name">Config</span> <span class="token punctuation">{</span></span>
<span class="line">    host<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span></span>
<span class="line">    port<span class="token punctuation">:</span> <span class="token keyword">u16</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">CONFIG</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">Config</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">get_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Config</span> <span class="token punctuation">{</span></span>
<span class="line">        host<span class="token punctuation">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        port<span class="token punctuation">:</span> <span class="token number">8080</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åœºæ™¯2-å¼‚æ­¥æ•°æ®åº“è¿æ¥æ± " tabindex="-1"><a class="header-anchor" href="#åœºæ™¯2-å¼‚æ­¥æ•°æ®åº“è¿æ¥æ± "><span>åœºæ™¯2ï¼šå¼‚æ­¥æ•°æ®åº“è¿æ¥æ± </span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">tokio<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceCell</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">sqlx<span class="token punctuation">::</span></span><span class="token class-name">PgPool</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">DB_POOL</span><span class="token punctuation">:</span> <span class="token class-name">OnceCell</span><span class="token operator">&lt;</span><span class="token class-name">PgPool</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">const_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_db_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> <span class="token class-name">PgPool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">DB_POOL</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">PgPool</span><span class="token punctuation">::</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;postgres://localhost/mydb&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token keyword">await</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;æ— æ³•è¿æ¥æ•°æ®åº“&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token attribute attr-name">#[tokio::main]</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> pool <span class="token operator">=</span> <span class="token function">get_db_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ä½¿ç”¨è¿æ¥æ± </span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åœºæ™¯3-http-å®¢æˆ·ç«¯å•ä¾‹" tabindex="-1"><a class="header-anchor" href="#åœºæ™¯3-http-å®¢æˆ·ç«¯å•ä¾‹"><span>åœºæ™¯3ï¼šHTTP å®¢æˆ·ç«¯å•ä¾‹</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">tokio<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceCell</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">reqwest<span class="token punctuation">::</span></span><span class="token class-name">Client</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">HTTP_CLIENT</span><span class="token punctuation">:</span> <span class="token class-name">OnceCell</span><span class="token operator">&lt;</span><span class="token class-name">Client</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">const_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_http_client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">HTTP_CLIENT</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Client</span><span class="token punctuation">::</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åœºæ™¯4-æ­£åˆ™è¡¨è¾¾å¼ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#åœºæ™¯4-æ­£åˆ™è¡¨è¾¾å¼ç¼“å­˜"><span>åœºæ™¯4ï¼šæ­£åˆ™è¡¨è¾¾å¼ç¼“å­˜</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceLock</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">regex<span class="token punctuation">::</span></span><span class="token class-name">Regex</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">email_regex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> <span class="token class-name">Regex</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token constant">REGEX</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">Regex</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token constant">REGEX</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Regex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">r&quot;^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">is_valid_email</span><span class="token punctuation">(</span>email<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">email_regex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_match</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="å…­ã€å¸¸ç”¨æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#å…­ã€å¸¸ç”¨æ–¹æ³•"><span>å…­ã€å¸¸ç”¨æ–¹æ³•</span></a></h2><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token comment">// 1. set - è®¾ç½®å€¼ï¼ˆåªèƒ½ä¸€æ¬¡ï¼‰</span></span>
<span class="line">cell<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. get - è·å–å¼•ç”¨</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. get_or_init - æ‡’åŠ è½½ï¼ˆæœ€å¸¸ç”¨ï¼‰</span></span>
<span class="line"><span class="token keyword">let</span> value <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token function">expensive_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 4. get_or_try_init - å¯èƒ½å¤±è´¥çš„åˆå§‹åŒ–</span></span>
<span class="line"><span class="token keyword">let</span> value <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">get_or_try_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> _<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token function">fallible_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 5. take - å–å‡ºå€¼</span></span>
<span class="line"><span class="token keyword">let</span> value <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 6. into_inner - è½¬æ¢ä¸º Option</span></span>
<span class="line"><span class="token keyword">let</span> option <span class="token operator">=</span> cell<span class="token punctuation">.</span><span class="token function">into_inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="ä¸ƒã€æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#ä¸ƒã€æœ€ä½³å®è·µ"><span>ä¸ƒã€æœ€ä½³å®è·µ</span></a></h2><h3 id="âœ…-æ¨èåšæ³•" tabindex="-1"><a class="header-anchor" href="#âœ…-æ¨èåšæ³•"><span>âœ… æ¨èåšæ³•</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token comment">// 1. å¼‚æ­¥ç¯å¢ƒç”¨ tokio::sync::OnceCell</span></span>
<span class="line"><span class="token attribute attr-name">#[tokio::main]</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">OnceCell</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">const_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token constant">DATA</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token keyword">async</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">fetch_from_api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. åŒæ­¥å¤šçº¿ç¨‹ç”¨ std::sync::OnceLock</span></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token constant">DATA</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">expensive_computation</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 3. å•çº¿ç¨‹ç”¨ std::cell::OnceCell</span></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">single_thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> cell <span class="token operator">=</span> <span class="token class-name">OnceCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    cell<span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="âŒ-é¿å…åšæ³•" tabindex="-1"><a class="header-anchor" href="#âŒ-é¿å…åšæ³•"><span>âŒ é¿å…åšæ³•</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token comment">// âŒ ä¸è¦åœ¨å¼‚æ­¥ç¯å¢ƒç”¨ OnceLock</span></span>
<span class="line"><span class="token attribute attr-name">#[tokio::main]</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// âš ï¸ è¿™ä¼šé˜»å¡ Tokio å·¥ä½œçº¿ç¨‹ï¼</span></span>
<span class="line">    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token constant">DATA</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token namespace">std<span class="token punctuation">::</span>thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// âŒ ä¸è¦ç”¨ spawn_blocking åŒ…è£… OnceLock</span></span>
<span class="line"><span class="token comment">// å¼€é”€å¤§ï¼Œè¿”å›å€¼ä¸æ˜¯ &amp;&#39;staticï¼Œä¸ä¼˜é›…</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="å…«ã€ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#å…«ã€ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”"><span>å…«ã€ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”</span></a></h2><h3 id="vs-lazy-static" tabindex="-1"><a class="header-anchor" href="#vs-lazy-static"><span>vs lazy_static</span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token comment">// âŒ æ—§æ–¹å¼ï¼šéœ€è¦å¤–éƒ¨ crate</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">lazy_static<span class="token punctuation">::</span></span>lazy_static<span class="token punctuation">;</span></span>
<span class="line"><span class="token macro property">lazy_static!</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token keyword">ref</span> <span class="token constant">CONFIG</span><span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token function">load_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// âœ… æ–°æ–¹å¼ï¼šæ ‡å‡†åº“</span></span>
<span class="line"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token class-name">OnceLock</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">CONFIG</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">fn</span> <span class="token function-definition function">get_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> <span class="token class-name">String</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">CONFIG</span><span class="token punctuation">.</span><span class="token function">get_or_init</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token function">load_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>âœ… æ ‡å‡†åº“ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–</li><li>âœ… æ›´çµæ´»ï¼ˆå¯è¿è¡Œæ—¶è®¾ç½®ï¼‰</li><li>âœ… æ›´è½»é‡</li></ul><h3 id="vs-mutex-option-t" tabindex="-1"><a class="header-anchor" href="#vs-mutex-option-t"><span>vs <code>Mutex&lt;Option&lt;T&gt;&gt;</code></span></a></h3><div class="language-rust line-numbers-mode" data-highlighter="prismjs" data-ext="rs"><pre><code><span class="line"><span class="token comment">// âŒ ç¹ççš„æ–¹å¼</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">None</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// âœ… ç®€æ´çš„æ–¹å¼</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token constant">DATA</span><span class="token punctuation">:</span> <span class="token class-name">OnceLock</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">OnceLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä¼˜åŠ¿ï¼š</span></span>
<span class="line"><span class="token comment">// - ä»£ç æ›´ç®€æ´</span></span>
<span class="line"><span class="token comment">// - åˆå§‹åŒ–åæ— é”è¯»å–ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰</span></span>
<span class="line"><span class="token comment">// - è¿”å› &amp;&#39;static å¼•ç”¨</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="ä¹ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ä¹ã€æ€»ç»“"><span>ä¹ã€æ€»ç»“</span></a></h2><h3 id="æ ¸å¿ƒè¦ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒè¦ç‚¹"><span>æ ¸å¿ƒè¦ç‚¹</span></a></h3><ol><li><p><strong>ä¸‰ç§ç±»å‹</strong>ï¼š</p><ul><li><code>OnceCell</code> = å•çº¿ç¨‹</li><li><code>OnceLock</code> = å¤šçº¿ç¨‹åŒæ­¥ï¼ˆä¼šé˜»å¡ï¼‰</li><li><code>tokio::OnceCell</code> = å¼‚æ­¥ï¼ˆä¸é˜»å¡ï¼‰</li></ul></li><li><p><strong>çº¿ç¨‹å®‰å…¨ â‰  å¼‚æ­¥</strong>ï¼š</p><ul><li><code>OnceLock</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†ä¼šé˜»å¡çº¿ç¨‹</li><li><code>tokio::OnceCell</code> æ—¢çº¿ç¨‹å®‰å…¨åˆå¼‚æ­¥</li></ul></li><li><p><strong>åœ¨ Tokio ä¸­å¿…é¡»ç”¨å¼‚æ­¥ç‰ˆæœ¬</strong>ï¼š</p><ul><li>å¦åˆ™ä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ï¼Œä¸¥é‡å½±å“æ€§èƒ½</li></ul></li><li><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>å…¨å±€å•ä¾‹</li><li>æ‡’åŠ è½½èµ„æº</li><li>é…ç½®ç®¡ç†</li><li>æ•°æ®åº“è¿æ¥æ± </li><li>HTTP å®¢æˆ·ç«¯</li></ul></li></ol><h3 id="è®°å¿†å£è¯€" tabindex="-1"><a class="header-anchor" href="#è®°å¿†å£è¯€"><span>è®°å¿†å£è¯€</span></a></h3><ul><li><strong>OnceCell</strong> = Cell å®¶æ— = å•çº¿ç¨‹</li><li><strong>OnceLock</strong> = Lock å®¶æ— = å¤šçº¿ç¨‹åŒæ­¥</li><li><strong>tokio::OnceCell</strong> = å¼‚æ­¥å‹å¥½ = Tokio ä¸“ç”¨</li></ul><h3 id="ä½¿ç”¨å»ºè®®" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å»ºè®®"><span>ä½¿ç”¨å»ºè®®</span></a></h3><table><thead><tr><th>åœºæ™¯</th><th>æ¨è</th></tr></thead><tbody><tr><td>Tokio å¼‚æ­¥ä»£ç </td><td><code>tokio::sync::OnceCell</code> â­</td></tr><tr><td>åŒæ­¥å¤šçº¿ç¨‹</td><td><code>std::sync::OnceLock</code></td></tr><tr><td>å•çº¿ç¨‹</td><td><code>std::cell::OnceCell</code></td></tr></tbody></table><p><strong>å…³é”®æ•™è®­</strong>ï¼šåœ¨ Tokio å¼‚æ­¥ç¯å¢ƒä¸­ï¼Œ<strong>å§‹ç»ˆä½¿ç”¨ <code>tokio::sync::OnceCell</code></strong>ï¼Œè€Œä¸æ˜¯ <code>std::sync::OnceLock</code>ã€‚è¿™ä¸ä»…æ˜¯ API é€‰æ‹©ï¼Œè€Œæ˜¯æ€§èƒ½å’Œæ­£ç¡®æ€§çš„å…³é”®ï¼ğŸš€âœ¨</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated:: </span><time class="meta-item-info" datetime="2025-10-26T15:24:42.000Z" data-allow-mismatch>10/26/25, 3:24 PM</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1030360567@qq.com">uponup</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/x-lang/assets/app-WzcM213c.js" defer></script>
  </body>
</html>
